<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>TIPQC Golden Hour Report</title>
  <script language="javascript" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
  <script language="javascript" type="text/javascript" src="http://datatables.net/download/build/jquery.dataTables.nightly.js"></script>
  <script type='text/javascript'>
    $(document).ready(function(){      
      $('.filtering_enabled').dataTable();
    });  
  </script>
  <style type="text/css">
    @media print{@page {size: landscape}}
    .page-break-before { page-break-before: always }
    .page-break-none { page-break-before: never }
    h2 { font-size: 1.25em }
    h3 { font-size: 1em}
    li { margin-bottom: 5px; }
    .section { margin-top: 20px;}
    .subsection { margin-bottom: 20px;}
    .redtext{color:red;}
  </style>
</head>
<body>
<%
    # create img file if not exists
    if (!file.exists("img")){
      dir.create(file.path(getwd(), "img"))
    }
  %>
    <center>
        <h1>- TIPQC Golden Hour Report -</h1>
        <%=
           format(Sys.time(), "%B %d, %Y %I:%M %p", usetz = TRUE)
        %>
    </center>
    <%
    begin.time<-Sys.time()
    begin.times <- format(begin.time, "%a %b %d, %Y at %X")
    previous.time <<- begin.time


        oldpar <- par(no.readonly = TRUE) # the whole list of settable pars.
        # set functions
        source("tipqc_GoldenHour_functions.R")		

        # format data
        source("tipqc_GoldenHour_formatData.R")

    %>
    <!-- ###################################################################################   -->
    <!-- ###################################################################################   -->
    <!-- ###################################################################################   -->

    <br/>
    <center>
      <p>
        <big> - <b>IMPORTANT</b> - </big>
        <br/>
        <em>This report is based on the most current information available in the REDCap database.</em>
        <br/>
        <em>There may be a lag in data entry (see below) and/or data entry errors that may cause discrepancies.</em>
      </p>
    </center>
    <br/>
    <!-- ###################################################################################   -->
    <!-- ####################### 1. Data Quality ###########################################   -->
    <!-- ###################################################################################   -->
    <ol>
        <li class="section"><h2>Data Quality</h2>
            <ol>
                
                    <!-- ############################## 1.1 Data Descriptives #################################   -->
                    <li><h3>Data Descriptives</h3>
                        <ul>
                            <li>As of 'today' (<%= format(thisreport, format = "%B %d, %Y") %>), a total of <%= nrow(hospdata) %> patients (ie, records) have been saved in REDCap for <%= ifelse(USER != "state_user", "your center", "all participating centers") %>.
                            </li>

                            <%
                            if(USER == "state_user") {

                               # For state_user, determine the number of records per participating clinic - will use in next section
                               record_counts <- data.frame(table(rdata$clinic))
                               record_counts <- record_counts[order(record_counts$Var1), ]
                               names(record_counts) <- c("Participating Center", "No. of patients")


                               cat("<li>The following table denotes the number of patients per participating center.\n")
                               print(xtable(record_counts, align = c("c", "c", "r")), type = "html", include.rownames = FALSE)
                               cat("</li><br/>")
                            }
                            previous.time <<- check_run_time(previous.time)
                            %>

                        </ul>
                    </li>
                    <!-- ############################## 1.2 Data Entry Checks #################################   -->
                    <li><h3>Data Entry Checks</h3>
                        <% if(USER == "state_user")
                            {
                              cat("Following are counts of possible errors in the REDCap database records for all centers:<br/><br/>")
                            }else
                              cat("Please check your REDCap database records for the following possible data errors:<br/><br/><ul>") 
                            
                            # subset where infant was admitted to nicu
                            rdata_nicu <<- subset(rdata,rdata$nicu==1)
                            clinicList = unique(rdata$clinic)
                            clinicList <<- clinicList[order(clinicList)]

                            dataChecksTable = rbind(
                              dataChecks('dob',rdata,c('study_id','mob','yob')),
                              dataChecks('ega',rdata_nicu,c('study_id','mob','yob','ega')),
                              dataChecks('apgar',rdata_nicu,c('study_id','mob','yob','apgar_1','apgar_5','apgar_10')),
                              dataChecks('fio2',rdata_nicu,c('study_id','mob','yob','fio2_5')),
                              dataChecks('sao2',rdata_nicu,c('study_id','mob','yob','sao2_5')),
                              dataChecks('dod',rdata_nicu,c('study_id','mob','yob','discharge_date_month','discharge_date_year'))
                            )
                            
                     
                            if(USER == "state_user")
                            {
                              # add totals column
                              dataChecksTable = cbind(dataChecksTable,rowSums(dataChecksTable))
                              
                              # add table row labels
                              rowLabels = c("A month/year of birth that is missing, occurring before May 2012, or occurring in the future",
                                "A missing gestational age at delivery (if admitted to NICU)",
                                "An APGAR score outside of the 0-10 range (if admitted to NICU)",
                                "An FiO2 score outside of the 0.21-1.0 range (if admitted to NICU)",
                                "An SaO2 score outside of the 0-100% range (if admitted to NICU)",
                                "A month/year of discharge occurring before month/year of birth, >1 year after birth, or in the future (if admitted to NICU)")
                              
                              # print html table with headers that span multiple columns
                              cat(paste("<table border=1>
                                          <tr>
                                            <th rowspan=2> 
                                              Data Entry Check
                                            </th> 
                                            <th colspan=",length(clinicList),"> 
                                              Participating Center 
                                            </th> 
                                            <th rowspan=2> 
                                              Total 
                                            </th>
                                          </tr>",sep=""))
                              # clinic headers
                              cat(paste("<tr><th>",apply(as.matrix(clinicList),2,paste,collapse="</th><th>&nbsp;"),"</th></tr>",sep="&nbsp"))
                              
                              # change color of numbers > 0 to red
                              add_redText = function(x){if(!is.character(x) & x>0){return(paste0("<td><span class='redtext'>&nbsp",x,"</span></td>"))}else{return(paste0("<td>&nbsp",x,"</td>"))}}
                              dataChecksTable_html = cbind(apply(as.matrix(rowLabels),c(1,2),add_redText),apply(dataChecksTable,c(1,2),add_redText))
                              dataChecksTable_html = paste0("<tr>",apply(dataChecksTable_html,1,paste0,collapse=""),"</tr>")
                              cat(dataChecksTable_html)
                              cat("</table>")
                            }

                            # remove records with missing mob, since that messes up everything past this point
                            rdata <<- subset(rdata,!is.na(rdata$month))
                            # remove records where dob occurs before pilot date (05/01/12) or after today
                            rdata <<- subset(rdata,as.Date(paste(rdata$yob,"-",rdata$mob_num,"-",1,sep=""))<=Sys.Date())
                            rdata <<- subset(rdata,as.Date(as.character(rdata$dob_fake),format="%m/%d/%y")>=as.Date("2012-05-01"))
                            
                            previous.time <<- check_run_time(previous.time)
  
                        %>
                        <span class="page-break-none"><h3><i>Note: From this point forward, records with a month/year of birth that is missing or outside the range of May 2012 - <%=format(thisreport, format = "%B %Y")%> are excluded from analysis. </i></h3></span></li>
			<% if(USER != "state_user") cat("</ul>") %>

			<!-- ############################## 1.3 Data Completion #################################   -->
			<li class="page-break-before"><h3>Data Completion</h3>
				<%	
					# table of summary of completion across 19 fields
					requiredFields_nicu = c('mob','yob','ega','pre_resusc_checklist','pre_resusc_briefing','apgar_1',
								'apgar_5','fio2_5','sao2_5','post_resusc_briefing','birthweight',
								'admit_temp','surfactant_eligible','iv_access_obtained',
								'glucose_win60','glucose_iv_started','antibiotics_ordered','resp_support_code',
								'pco2_indicated','parents_commun')
          requiredFields_nonNicu = c('mob','yob','pre_resusc_checklist','pre_resusc_briefing', 'post_resusc_briefing', 
                'apgar_1','apgar_5','fio2_5','sao2_5')
                        
					# subset of required fields from kick-off (9/2012)
					requiredFieldsSubset_nicu = subset(rdata,as.Date(as.character(rdata$dob_fake),format="%m/%d/%y")>=as.Date("2012-09-01") & rdata$nicu=="1",select=c('clinic',requiredFields_nicu))
          requiredFieldsSubset_nonNicu = subset(rdata,as.Date(as.character(rdata$dob_fake),format="%m/%d/%y")>=as.Date("2012-09-01") & rdata$nicu=="0",select=c('clinic',requiredFields_nonNicu))					
					
					if(USER=="state_user")
					{
						cat(paste("The following table depicts the percent completion of all required fields for each participating center from the kick-off date (September 2012).
              Record entries that are non-missing are considered 'complete'.
              The required fields are the ",length(requiredFields_nicu)," fields plotted in this section of the report.
              The fields plotted in the last two charts are only applicable for infants that needed further stabilization or treatment after the initial resuscitation.<br/><br/> ",sep=''))
						numerator = c()
						denominator = c()
						numRecordsFromKickoff = c()
						for(clinic in 1:length(clinicList))
						{
							
							myClinic = clinicList[clinic]
              # admitted to nicu
							clinic_subset_nicu = subset(requiredFieldsSubset_nicu,requiredFieldsSubset_nicu$clinic==myClinic,select=requiredFields_nicu)
							notNA_nicu = !is.na(clinic_subset_nicu)
              # not admitted to nicu
              clinic_subset_nonNicu = subset(requiredFieldsSubset_nonNicu,requiredFieldsSubset_nonNicu$clinic==myClinic,select=requiredFields_nonNicu)
							notNA_nonNicu = !is.na(clinic_subset_nonNicu)
              # calculate completion percentage
							numerator = c(numerator,sum(notNA_nicu)+sum(notNA_nonNicu))
							denominator = c(denominator,(nrow(clinic_subset_nicu)*length(requiredFields_nicu)) + (nrow(clinic_subset_nonNicu)*length(requiredFields_nonNicu)))
							numRecordsFromKickoff = c(numRecordsFromKickoff,nrow(clinic_subset_nicu)+nrow(clinic_subset_nonNicu))
						}
						#calculate totals
						numerators_All = c(numerator,sum(numerator))
						denominators_All = c(denominator,sum(denominator))
						percentComplete = paste(round(numerators_All/denominators_All*100,0),"%",sep="")
						numRecordsFromKickoff = c(numRecordsFromKickoff,sum(numRecordsFromKickoff))
						
						# make HTML table
						cat(paste("<table border=1>
              <thead>
                <tr>
    							<th rowspan=2> 
  								</th> 
  								<th colspan=",length(clinicList),"> 
  									Participating Center 
  								</th> 
  								<th rowspan=2> 
  									Total 
  								</th>
  							</tr>
              </thead>
							<tbody>
							<tr>
                <th></th>
						",sep=""))
						for(clinic in 1:length(clinicList))
						{
							cat(paste("<th>",clinicList[clinic],"</th>",sep=""))
						}
						cat("</tr>")
						cat("<tr><td>")
						cat("Data % Completion of Required Fields")
						cat("</td>")
						for(percent in 1:length(percentComplete))
						{
							cat(paste("<td>",percentComplete[percent],"</td>",sep=""))
						}
						cat("</tr><tr><td>No. Records From Kick-off Date</td>")
						for(num in 1:length(numRecordsFromKickoff))
						{
							cat(paste("<td>",numRecordsFromKickoff[num],"</td>",sep=""))
						}
						cat("</tr></tbody></table>")
						
					}else
					{
						numerator = sum(!is.na(subset(requiredFieldsSubset_nicu,select=requiredFields_nicu))) + sum(!is.na(subset(requiredFieldsSubset_nonNicu,select=requiredFields_nonNicu)))
						denominator = (nrow(requiredFieldsSubset_nicu)*length(requiredFields_nicu)) + (nrow(requiredFieldsSubset_nonNicu)*length(requiredFields_nonNicu))
						percentComplete = paste(round(numerator/denominator*100,0),"%",sep="")
						cat(paste("Your center has an overall completion rate of ",percentComplete," (N=",nrow(requiredFieldsSubset_nicu)+nrow(requiredFieldsSubset_nonNicu)," records) since the kick-off date (September 2012). This percentage is calculated using the ",length(requiredFields_nicu)," required fields that are plotted in this section of the report. The fields plotted in the last two charts are only applicable for 
                                                    infants that needed further stabilization or treatment after the initial resuscitation. Record entries that are non-missing are considered 'complete'. ",sep=""))
					}
          
          previous.time <<- check_run_time(previous.time)
          
					# % completion by month
					
					h = 480					
					w = 1250
					title = "Data % Completion By Month"
					
					# chart 1
					# start writing png
					png('img/pchart_completion1.png',height=h,width=w)
            columnList = c('mob','yob','pre_resusc_checklist','pre_resusc_briefing','post_resusc_briefing')
  					option = 1
  					lowerYlim = 30
  					chart1_plotdata = pchart(rdata,columnList,title,option,lowerYlim)										
					dev.off()
					
					# chart 2
					png('img/pchart_completion2.png',height=h,width=w)
					  pchart(rdata,c('apgar_1','apgar_5','fio2_5','sao2_5'),title,1,lowerYlim)
					dev.off()
                                        
          # chart 3
          png('img/pchart_completion3.png',height=h,width=w)
            nicu_subset <<- subset(rdata,rdata$nicu=='1')
            columnList = c('ega','birthweight','parents_commun','admit_temp','surfactant_eligible')
  					pchart(nicu_subset,columnList,title,1,lowerYlim)
					dev.off()
          
					# chart 4
					png('img/pchart_completion4.png',height=h,width=w)
  					pchart(nicu_subset,c('iv_access_obtained','glucose_win60','glucose_iv_started','antibiotics_ordered','resp_support_code','pco2_indicated'),title,1,lowerYlim)
					dev.off()
        
				%>
				<center><img src="img/pchart_completion1.png"></center>
				<center><img src="img/pchart_completion2.png"></center>
        <br/>
        <br/>
        <p>Note that the fields plotted in these next two charts are only applicable for infants that needed further stabilization or treatment after the initial resuscitation.</p>
        <center><img src="img/pchart_completion3.png"></center>
				<center><img src="img/pchart_completion4.png"></center>
			</li>
		</ol>
    <% previous.time <<- check_run_time(previous.time) %>
		<!-- ###################################################################################   -->
		<!-- ############################# 2.0 Pre-resuscitation ###############################   -->
		<!-- ###################################################################################   -->
		<li class="section page-break-before">
                    <h2>Pre-resuscitation</h2></li>
			<%
				### 2.0 ###
										
				title = "Percent Pre-resuscitation Checklist/Briefing Completed"
				
				# start writing png
				png('img/pchart_preresus.png',height=h,width=w)				
  				# Expand right side of clipping rect to make room for the legend
  				par(xpd=T, mar=par()$mar+c(0,7,0,7))			
  				# chart 1
  				pchart(rdata,c("pre_resusc_checklist","pre_resusc_briefing"),title,"2",30)
				dev.off()
				
				# Restore default clipping rect
				par(mar=c(5, 4, 4, 2) + 0.1)
			%>
			<center><img src="img/pchart_preresus.png"></center>
		
    <% previous.time <<- check_run_time(previous.time) %>
		<!-- ###################################################################################   -->
		<!-- ########################### 3.0 Resuscitation #####################################   -->
		<!-- ###################################################################################   -->
		<li class="section page-break-before">
                    <h2>Resuscitation</h2>
			<ol>
                        <!-- ########################## 3.1 Supplemental Oxygen Management #####################   -->
                        <li><h3>Supplemental Oxygen Management</h3>
                            Acceptable oxygen saturation levels are not clearly defined.  For this project, teams attempt to titrate supplemental O2 to achieve an SaO2 within the range reported for well infants at 5 minutes who required no supplemental O2. (Dawson, Pediatrics, 2010)  To facilitate titration of supplemental oxygen in infants requiring resuscitation, three sub-groups within the normoxic range for healthy infants at 5 minutes of life are identified in the following graph: near target-low, on target (NRP), and near target-high.<br/><br/>
                                <ol>
                                        <li><b>Scatter Plot of FiO2 and SaO2 for all cases since Statewide kickoff</b>
                                        <ul>
                                                <li>The following figure illustrates the number of records above target, on target, and below target. Each point represents an infant. Definitions concerning target range are as follows:
                                                <ul>
                                                        <li><b>Above NRP target</b> - SaO2 from 86-100% and FiO2 from 0.22-1.0 (excludes infants on room-air)</li>
                                                        <li><b>Within NRP target</b> - SaO2 from 80-85%</li>
                                                        <li><b>Below NRP target</b> - SaO2 from 0 to 79% and FiO2 from 0.21-0.99 (excludes infants who are already on maximal FiO2)</li>
                                                </ul>
                                                </li>
                                                <%
                                                        h = 600				
                                                        w = 850


                                                        # start writing png
                                                        png('img/chart_fio2_sao2_rank.png',height=h,width=w)
                                                        # grab all data AFTER KICKOFF DATE where sao2 and fio2 are not NA
                                                        junk <- subset(rdata, !is.na(sao2_5) & !is.na(fio2_5) & as.Date(as.character(dob_fake),format="%m/%d/%y")>=as.Date("2012-09-01"), select = c(study_id, sao2_5,fio2_5,month))
                                                        junk <- junk[order(junk$sao2_5),]
                                                        #junk$new_id <- 1:nrow(junk)
                                                        par(xpd=F,mar = c(5, 5, 2, 4)+0.1, las = 1)
                                                        with(junk,{
                                                                plot(fio2_5, sao2_5, ylab = "SaO2 @ 5 min", xlab = "FiO2 @ 5 min",
                                                                xlim = c(.21, 1.0),
                                                                ylim = c(0,100),
                                                                pch=19,cex=.8,axes=FALSE)

                                                        })
                                                        axis(side = 1, at = c(.21,.3,.4,.5,.6,.7,.8,.9,1.0))
                                                        axis(side = 2)
                                                        box()
                                                        #ON TARGET
                                                        abline(h=80)
                                                        abline(h=85)
                                                        text(x=.21+(1-.21)/2,y=82.5,labels="ON TARGET")
                                                        #rect(.20,86,.22,101)
                                                        #above
                                                        rect(.22,86,1,100)
                                                        text(x=.385+.22,y=86+7,labels="ABOVE")
                                                        #below
                                                        rect(.21,0,.99,79)
                                                        text(x=.22+(.99-.22)/2,y=(79/2),labels="BELOW")


                                                        # end writing png
                                                        dev.off()
                                                %>
                                        <center><img src="img/chart_fio2_sao2_rank.png"></center>


                                        </ul>        
                                        </li>
                                        <br/>
                                        <br/>
                                        <% previous.time <<- check_run_time(previous.time) %>
                                        <li class="page-break-before"><b>Infants Within Approximate Transition Saturation Ranges (75% < SaO2 < 95%)</b><br/><br/>
                                            <% 
                                                h = 480				
                                                w = 1250
                                                # start writing png
                                                png('img/pchart_oxygen1.png',height=h,width=w)                                                 
                                                  # option 6
                                                  cleaned_data = subset(rdata,(!is.na(rdata$sao2_5) & !is.na(rdata$fio2_5)) & !(rdata$sao2_5>=95 & rdata$fio2_5==0.21))
                                                  option6 = pchart_data(cleaned_data,"sao2_5",function(x){return(sum(x>75 & x<95))})
                                                  title = "Infants Within Approximate Transition Ranges"
                                                  pchart_plot(option6,title,parmar=c(5, 4, 4, 2) + 0.1+c(7,7,0,25)) # expand bottom margin
                                                  # add "Room air and above average" margin (saO2>=95% and FiO2=.21)
                                                  mtext(side = 1, text = "Room air and above average:", at = 0.75, adj = 1, line = 5, cex = 0.85, font=2)
                                                  roomAirAboveAverage = pchart_data(subset(rdata,(rdata$sao2_5>=95 & rdata$fio2_5==0.21)),"sao2_5",length)$numerator
                                                  axis(side=1,at=1:length(monthList),labels=roomAirAboveAverage,hadj=1,tick = FALSE,cex.axis=.85,line=4,font=2) 
                                                  # add missing sao2/fio2 count in margin
                                                  mtext(side = 1, text = "Missing SaO2 and/or FiO2:", at = 0.75, adj = 1, line = 6, cex = 0.85, font=2)
                                                  missingSao2_fio2 = pchart_data(subset(rdata,is.na(rdata$sao2_5) | is.na(rdata$fio2_5)),"month",length)$numerator
                                                  axis(side=1,at=1:length(monthList),labels=missingSao2_fio2,hadj=1,tick = FALSE,cex.axis=.85,line=5,font=2) 
                                                dev.off()
                                                # Restore default clipping rect
                                                par(mar=c(5, 4, 4, 2) + 0.1)
                                            %>
                                            <div class="page-break-none"> 
                                            <ul>
                                                <b>Definitions:</b>
                                                <ul>
                                                    <li><b>Percentage of Infants Within Approximate Transition Ranges</b>
                                                        <ul>
                                                            <li><b>Numerator</b> - 75% &lt; SaO2 &lt; 95%</li>
                                                            <li><b>Denominator (n)</b> - all records where SaO2 and FiO2 were recorded excluding "Room air and above average" records (defined below)
                                                        </ul>
                                                    </li>
                                                    <li> <b>Margin Counts</b>
                                                        <ul>
                                                            <li><b>Room air and above average</b> - SaO2 &ge; 95% and FiO2 = 0.21</li>
                                                            <li><b>Missing SaO2 and/or FiO2</b> - SaO2 and/or FiO2 = NA</li>
                                                        </ul>

                                                    </li>
                                                </ul>  
                                                <br/><center><img class="page-break-none" src="img/pchart_oxygen1.png"></center>
                                               
                                            </ul> 
                                            </div>

                                        </li>	
                                        <% previous.time <<- check_run_time(previous.time) %>
                                        <li class="page-break-before"><b>Infants Receiving Supplemental Oxygen with an SaO2 within the NRP Target Range at 5 minutes of life</b><br/><br/>
                                            <% 
                                                h = 480				
                                                w = 1250

                                                # start writing png
                                                png('img/pchart_oxygen2.png',height=h,width=w)
                                                  title = "Infants Receiving Supplemental Oxygen Within 5 Minute NRP Target"
                                                  # option 7
                                                  cleaned_data = subset(rdata,(!is.na(rdata[,"sao2_5"]) & !is.na(rdata[,"fio2_5"]) & rdata[,"fio2_5"]>0.21))
                                                  option7 = pchart_data(cleaned_data,"sao2_5",function(x){return(sum(x>=80 & x<=85))})
                                                  pchart_plot(option7,title,parmar=c(5, 4, 4, 2) + 0.1+c(7,7,0,25)) # expand bottom margin
                                                  # add "Max O2 and below target" margin (saO2<85% and FiO2=1.0)
                                                  mtext(side = 1, text = "Max O2 and below target:", at = 0.75, adj = 1, line = 5, cex = 0.85, font=2)
                                                  maxO2_belowTarget = pchart_data(subset(rdata,(!is.na(rdata$sao2_5) & !is.na(rdata$fio2_5)) & (rdata$sao2_5<85 & rdata$fio2_5==1)),"sao2_5",length)$numerator
                                                  axis(side=1,at=1:length(monthList),labels=maxO2_belowTarget,hadj=1,tick = FALSE,cex.axis=.85,line=4,font=2) 
                                                  
                                                  # add missing sa02/fio2 count in margin
                                                  mtext(side = 1, text = "Missing SaO2 and/or FiO2:", at = 0.75, adj = 1, line = 6, cex = 0.85, font=2)
                                                  axis(side=1,at=1:length(monthList),labels=missingSao2_fio2,hadj=1,tick = FALSE,cex.axis=.85,line=5,font=2)
                                                dev.off()
                                                # Restore default clipping rect
                                                par(mar=c(5, 4, 4, 2) + 0.1)
                                            %>
                                           <div class="page-break-none"> 
                                            <ul>
                                                <b>Definitions:</b>
                                                <ul>
                                                    <li><b>Percentage of Infants Receiving Supplemental Oxygen Within 5 Minute NRP Target</b>
                                                        <ul>
                                                            <li><b>Numerator</b> - 80% &le; SaO2 &le; 85%</li>
                                                            <li><b>Denominator (n)</b> - all records where SaO2 and FiO2 were recorded AND FiO2 &gt; 0.21
                                                        </ul>
                                                    </li>
                                                    <li> <b>Margin Counts</b>
                                                        <ul>
                                                            <li><b>Max O2 and below target</b> - SaO2 &lt; 85% and FiO2 = 1.0</li>
                                                            <li><b>Missing SaO2 and/or FiO2</b> - SaO2 and/or FiO2 = NA</li>
                                                        </ul>

                                                    </li>
                                                </ul>  
                                                <br/><center><img class="page-break-none" src="img/pchart_oxygen2.png"></center></li>
                                            </ul> 
                                           </div>

                                        </li>	
                                        <% previous.time <<- check_run_time(previous.time) %>
                                        <%
                                            # grab all data AFTER KICK-OFF DATE where fio2 is not NA and is >.21(sao2 may be NA)
                                            tempData = subset(rdata, !is.na(fio2_5) & fio2_5>.21 & !is.na(month) & as.Date(as.character(dob_fake),format="%m/%d/%y")>=as.Date("2012-09-01"), select = c(study_id, sao2_5,fio2_5,month))
                                            months = seq(as.Date("2012-09-01"), Sys.Date(), by="1 month")
                                            monthList = format(months,"%m/%Y")
                                            denomList = c()
                                            onTarget = c()


                                            plotData = data.frame();
                                            for(month in 1:length(monthList))
                                            {
                                                            monthSub = tempData[tempData$month==monthList[month],]

                                                            # sao2 = NA
                                                            sao2NA = sum(is.na(monthSub$sao2_5) )

                                                            # max o2 and below range
                                                            maxO2below = sum(monthSub$sao2_5<= 75 & monthSub$fio2_5==1.0 & !is.na(monthSub$sao2_5))

                                                            # below range (SaO2 from 0-75% and FiO2 from 0.22-.99)
                                                            belowNum = sum(monthSub$sao2_5>=0 & monthSub$sao2_5<=75 & !is.na(monthSub$sao2_5) & monthSub$fio2_5<=.99) 		

                                                            # below target in range (SaO2 from 76%-79% and FiO2 from 0.22-1.0)
                                                            belowInRangeNum = sum(monthSub$sao2_5>75 & monthSub$sao2_5<80 & !is.na(monthSub$sao2_5)) 	

                                                            # on NRP target (SaO2 from 80-85% and FiO2 from 0.22-1.0)
                                                            onNum = sum(monthSub$sao2_5>=80 & monthSub$sao2_5<=85 & !is.na(monthSub$sao2_5)) 

                                                            # above target in range (SaO2 from 86-94% and FiO2 from 0.22-1.0)
                                                            aboveInRangeNum = sum(monthSub$sao2_5>85 & monthSub$sao2_5<95 & !is.na(monthSub$sao2_5)) 

                                                            # above range (SaO2 from 95-100% and FiO2 from 0.22-1.0)
                                                            aboveNum = sum(monthSub$sao2_5>=95 & !is.na(monthSub$sao2_5)) 

                                                            # These should be the same
                                                            #print(nrow(monthSub))				
                                                            #print(sao2NA+maxO2below+belowNum+belowInRangeNum+onNum+aboveInRangeNum+aboveNum)					

                                                            denominator = sao2NA+maxO2below+belowNum+belowInRangeNum+onNum+aboveInRangeNum+aboveNum


                                                            # max o2 and below range
                                                            plotData[1,month] = maxO2below / denominator*100
                                                            # below range 
                                                            plotData[2,month] = belowNum / denominator*100
                                                            # below target in range
                                                            plotData[3,month] = belowInRangeNum / denominator*100
                                                            # on NRP target
                                                            plotData[4,month] = onNum / denominator*100
                                                            # above target in range
                                                            plotData[5,month] = aboveInRangeNum / denominator*100									
                                                            # above range 
                                                            plotData[6,month] = aboveNum / denominator*100
                                                            # NA
                                                            plotData[7,month] = sao2NA / denominator*100


                                                            denomList = c(denomList,denominator)
                                            }
                                            colnames(plotData) = monthList
                                            rownames(plotData) = c("Max O2 and Below Range", "Below Range","Below Target in Range","On NRP Target","Above Target in Range","Above Range","NA")

                                            h = 600					
                                            w = 1000
                                            # start writing png
                                            png('img/barchart_targetRange.png',height=h,width=w)
                                            par(xpd=T, mar=par()$mar+c(0,7,5,12))

                                            barPlotData = as.matrix(plotData)
                                            b = barplot(barPlotData,
                                                              main="Infants Receiving Supplemental Oxygen at 5 Minutes",
                                                              col=c("gray","blue","light blue","green","pink","red","yellow"),
                                                              xlab = "Month",
                                                              ylab = "Percent"							  
                                             )
                                             box(lty=1,col='black')
                                             #legendpos = ((tail(b,2)[2]-tail(b,2)[1]))*length(b)/3.5*-1
                                             legend("topright",inset=c(-.3,0),rev(rownames(plotData)),fill=rev(c("gray","blue","light blue","green","pink","red","yellow")))
                                             # add n at the bottom
                                            mtext(side = 1, text = "Total No. Records (n):", at = 0.45, adj = 1, line = 4, cex = 0.85, font=2)
                                            axis(side=1,at=b,labels=denomList,tick = FALSE,cex.axis=.85,line=3,font=2)
                                            # add percentage labels if percentage >=5%
                                            # Find the top y position of each block 
                                            ypos <- apply(barPlotData, 2, cumsum)
                                            # Move it downwards half the size of each block
                                            ypos <- ypos - barPlotData/2

                                            if(nrow(barPlotData)>0)
                                            {
                                                            for(row in 1:nrow(barPlotData))
                                                            {
                                                                            for(col in 1:ncol(barPlotData))
                                                                            {
                                                                                            if(!is.na(barPlotData[row,col])) 
                                                                                            {
                                                                                                if(!is.nan(barPlotData[row,col]) && round(barPlotData[row,col])>=5){
                                                                                                            text(b[col],ypos[row,col],paste(round(barPlotData[row,col]),"%",sep=""))
                                                                                                }

                                                                                            }
                                                                            }
                                                            }
                                            }


                                            # add No. clinics participating at the top
                                            if(USER == "state_user")
                                            {
                                                            clinicCount = c()
                                                            for(month in 1:length(monthList))
                                                            {
                                                                            clinicCount = c(clinicCount,length(unique(rdata$clinic[rdata$month==monthList[month]])))
                                                            }
                                                            mtext(side = 3, text = "No. centers contributing data:", at = 0.0, adj = 1, line = 1, cex = 0.85,font=2)
                                                             axis(side=3,at=b,labels=clinicCount,hadj=1,tick = FALSE,cex.axis=.85,line=0,font=2) 
                                            }
                                            # end writing png
                                            dev.off()
                                            
                                            
                                        %>
                                        <li class="page-break-before"><b>Infants Receiving Supplemental Oxygen At 5 Minutes</b><br/><br/>
                                            <ul>
                                                <li> The following stacked bar chart displays the percentages of infants in different SaO2 ranges at 5 minutes. The denominator is all records with a non-missing FiO2 > 0.21. Definitions concerning the numerators are as follows: 
                                                    <ul>
                                                        <li><b>NA</b> - SaO2 is not recorded</li>
                                                        <li><b>Above Range</b> - SaO2 from 95-100% and FiO2 from 0.22-1.0</li>
                                                        <li><b>Above Target in Range</b> - SaO2 from 86-94% and FiO2 from 0.22-1.0</li>
                                                        <li><b>On NRP Target</b> - SaO2 from 80-85% and FiO2 from 0.22-1.0</li>
                                                        <li><b>Below Target in Range</b> - SaO2 from 76%-79% and FiO2 from 0.22-1.0</li>
                                                        <li><b>Below Range</b> - SaO2 from 0-75% and FiO2 from 0.22-.99</li>
                                                        <li><b>Max O2 and Below Range</b> - SaO2 from 0-75% and FiO2 = 1.0</li>
                                                    </ul>
                                                    <center><img class="page-break-none" src="img/barchart_targetRange.png"></center>
                                                    
                                                </li>
                                            </ul>
                                            
                                        </li>
                                        
                                </ol>
                        </li>
         
         <% previous.time <<- check_run_time(previous.time) %>
				<!-- ########################## 3.2 Thermal Management #################################   -->
				<li class="page-break-before"><h3>Thermal Management - Only Applicable to Infants Admitted to NICU</h3>
					
                                    <%
                                            tempData = subset(nicu_subset,select=c("month","admit_temp"))
                                            tempData_notNA = subset(tempData,!is.na(tempData$admit_temp))
                                            #monthList = unique(rdata$month[!is.na(rdata$month)])
                                            months = seq(as.Date("2012-05-01"), Sys.Date(), by="1 month")
                                            monthList = format(months,"%m/%Y")
                                            denomList = c()


                                            plotData = data.frame();
                                            for(month in 1:length(monthList))
                                            {
                                                    denominator = sum(tempData$month==monthList[month])
                                                    # hypothermic (<36.0 C)
                                                    plotData[1,month] = sum(tempData_notNA[,2][tempData_notNA$month==monthList[month]]<36) / denominator*100
                                                    # cool (36 - <36.5)
                                                    plotData[2,month] = sum(tempData_notNA[,2][tempData_notNA$month==monthList[month]]>=36 & tempData_notNA[,2][tempData_notNA$month==monthList[month]] < 36.5) / denominator*100
                                                    # normothermic (36.5 - 37.5)
                                                    plotData[3,month] = sum(tempData_notNA[,2][tempData_notNA$month==monthList[month]]>=36.5 & tempData_notNA[,2][tempData_notNA$month==monthList[month]] <= 37.5) / denominator*100

                                                    # hyperthermic (>37.5)
                                                    plotData[4,month] = sum(tempData_notNA[,2][tempData_notNA$month==monthList[month]]>37.5) / denominator*100
                                                    # NA
                                                    plotData[5,month] = sum(is.na(tempData[,2][tempData$month==monthList[month]])) / denominator*100

                                                    denomList = c(denomList,denominator)
                                            }
                                            colnames(plotData) = monthList
                                            rownames(plotData) = c("hypothermic (<36.0C)", "cool (36.0-36.4C)","normothermic (36.5-37.5C)","hyperthermic (>37.5C)","N/A")

                                            h = 600					
                                            w = 1000
                                            # start writing png
                                            png('img/barchart_admitTemp.png',height=h,width=w)
                                            par(xpd=T, mar=par()$mar+c(0,7,5,12))

                                            barPlotData = as.matrix(plotData)
                                            b = barplot(barPlotData,
                                                      main="Temperature of Admission to the NICU for Golden Hour Infants",
                                                      col=c("blue","light blue","green","red","purple"),
                                                      xlab = "Month",
                                                      ylab = "Percent"							  
                                             )
                                             box(lty=1,col='black')
                                             #legendpos = ((tail(b,2)[2]-tail(b,2)[1]))*length(b)/3.5*-1
                                             legend("topright",inset=c(-.3,0),rev(rownames(plotData)),fill=rev(c("blue","light blue","green","red","purple")))
                                             # add n at the bottom
                                            mtext(side = 1, text = "Total No. Records (n):", at = 0.45, adj = 1, line = 4, cex = 0.85, font=2)
                                            axis(side=1,at=b,labels=denomList,tick = FALSE,cex.axis=.85,line=3,font=2)
                                            # add percentage labels if percentage >=5%
                                            # Find the top y position of each block 
                                            ypos <- apply(barPlotData, 2, cumsum)
                                            # Move it downwards half the size of each block
                                            ypos <- ypos - barPlotData/2

                                            if(nrow(barPlotData)>0)
                                            {
                                                    for(row in 1:nrow(barPlotData))
                                                    {
                                                            for(col in 1:ncol(barPlotData))
                                                            {
                                                                    if(!is.na(barPlotData[row,col])) 
                                                                    {
                                                                        if(!is.nan(barPlotData[row,col]) && round(barPlotData[row,col])>=5){
                                                                            text(b[col],ypos[row,col],paste(round(barPlotData[row,col]),"%",sep=""))
                                                                        }
                                                                    }
                                                            }
                                                    }
                                            }


                                            # add No. clinics participating at the top
                                            if(USER == "state_user")
                                            {
                                                    clinicCount = c()
                                                    for(month in 1:length(monthList))
                                                    {
                                                            clinicCount = c(clinicCount,length(unique(rdata$clinic[rdata$month==monthList[month]])))
                                                    }
                                                    mtext(side = 3, text = "No. centers contributing data:", at = 0.0, adj = 1, line = 1, cex = 0.85,font=2)
                                                     axis(side=3,at=b,labels=clinicCount,hadj=1,tick = FALSE,cex.axis=.85,line=0,font=2) 
                                            }

                                            # end writing png
                                            dev.off()

                                            # Restore default clipping rect
                                            par(mar=c(5, 4, 4, 2) + 0.1)
                                    %>
                                    <ol>
                                        <li>Temperature of Admission to the NICU for Golden Hour Infants
                                            <center><img class="page-break-none" src="img/barchart_admitTemp.png"></center>
                                        </li>
                                        <% previous.time <<- check_run_time(previous.time) %>
                                        <li class="page-break-before">Percent in Target Range<br/><br/>
                                            <% 
                                                h = 480				
                                                w = 1250
                                                # start writing png
                                                png('img/pchart_thermalTargetRange.png',height=h,width=w)
                                                  title = "Admission Temperature - Percent in Target Range"
                                                  cleaned_data = nicu_subset # We DO want to penalize an admission temperature of NA, so leave in denominator
                                                  option4_data = pchart_data(cleaned_data,"admit_temp",function(x){return(sum(x>=36 & x<=37.5))})
                                                  pchart_plot(option4_data,title)
                                                dev.off()
                                            %>
                                            <ul>
                                                <li> The following figure illustrates the percent of records within the target range for each month. The target range is defined as records with a cool (36.0-36.4C) or normothermic (36.5-37.5C) admission temperature.<br/>
                                                 <center><img class="page-break-none" src="img/pchart_thermalTargetRange.png"></center> </li>

                                            </ul> 


                                        </li>						
                                    </ol>
				</li>
			</ol>
		</li>
                <% previous.time <<- check_run_time(previous.time) %>
                <!-- ###################################################################################   -->
                <!-- ####################### 4. Surfactant #############################################   -->
                <!-- ###################################################################################   -->
                 <li class="section page-break-before"><h2>Surfactant</h2>
                    <%
                    png('img/pchart_surfactant.png',height=h,width=w)
                      # option 5
                      columnOfInterest = "surfactant_received"
                      cleaned_data = subset(nicu_subset, nicu_subset$surfactant_eligible=="Yes") 
                      option5 = pchart_data(cleaned_data,columnOfInterest,function(x){return(sum(x=="Yes"))})
                      pchart_plot(option5,"Percent Surfactant Received",shifts="manual",nlabel="Total No. Surfactant \nEligible Records (n):")
                      # 09/2012 - 01/2013
                      addShift(points=option5$numerator,groupSizes=option5$denominator,monthList,"2012-09-01","2013-01-01")
                      # 01/2013 - forward
                      addShift(points=option5$numerator,groupSizes=option5$denominator,monthList,"2013-01-01","end")
                    dev.off()
                    %>
                    <ul>
                        <li> The following figure illustrates the percent of records that received surfactant out of all the surfactant-eligible records. (Note: Eligibility as determined by local protocol)
                        <center><img class="page-break-none" src="img/pchart_surfactant.png"></center>
                    </ul>
                
                 </li>
                 <% previous.time <<- check_run_time(previous.time) %>
                <!-- ###################################################################################   -->
                <!-- ########## 5. Age First IV Access Obtained (Minutes of Life) ######################   -->
                <!-- ###################################################################################   -->
                <li class="section page-break-before"><h2>Age First IV Access Obtained (Minutes of Life)</h2>
                    <ul>
                        <li> 
                        <%
                            xbarI_section(nicu_subset,'iv_access_age')
                            # add monthly mean xbar chart
                              png('img/mchart_firstaccessobtained.png',height=h,width=w-100)
                                data_remove_nas = subset(nicu_subset,!is.na(nicu_subset$iv_access_age))
                                column = 'iv_access_age'
                                my_qcc = xbarI_mean_plot(nicu_subset,column,yaxis_label="Minutes of Life")
                                ymax = max(my_qcc$limits)+5
                                ymin = min(my_qcc$limits)-5
                                mchart_plotdata = mchart(nicu_subset,column,c(ymin,ymax))
                                # if state user, add manually-entered shifts, otherwise no shifts
                                if(USER=="state_user"){
                                  addShift(points=mchart_plotdata$y,groupSizes=mchart_plotdata$count,monthList,fromDate="2012-05-01",toDate="2013-01-01","xbar",data_remove_nas,column)
                                  addShift(points=mchart_plotdata$y,groupSizes=mchart_plotdata$count,monthList,"2013-01-01","end","xbar",data_remove_nas,column)
                                }else{
                                  addShift(points=mchart_plotdata$y,groupSizes=mchart_plotdata$count,monthList,fromDate="2012-05-01",toDate="end","xbar",data_remove_nas,column)
                                }
                              dev.off()
                              cat('<center><img class="page-break-none" src="img/mchart_firstaccessobtained.png"></center>')
                            
                        %>     
                        
                    </ul>
                </li>
                <% previous.time <<- check_run_time(previous.time) %>
                <!-- ###################################################################################   -->
                <!-- ########## 6. Age Glucose IV Solution Started (Minutes of Life) ###################   -->
                <!-- ###################################################################################   -->
                <li class="section"><h2>Age Glucose IV Solution Started (Minutes of Life)</h2>
                    <ul>
                        <li> 
                        <%
                            xbarI_section(nicu_subset,'glucose_iv_started_age')
                            # add monthly mean xbar chart
                            
                              png('img/mchart_glucose_iv_started_age.png',height=h,width=w-100)
                                data_remove_nas = subset(nicu_subset,!is.na(nicu_subset$glucose_iv_started_age))
                                column = 'glucose_iv_started_age'
                                my_qcc = xbarI_mean_plot(nicu_subset,column,yaxis_label="Minutes of Life")
                                ymax = max(my_qcc$limits)+5
                                ymin = min(my_qcc$limits)-5
                                mchart_plotdata = mchart(nicu_subset,column,c(ymin,ymax))
                                addShift(points=mchart_plotdata$y,groupSizes=mchart_plotdata$count,monthList,fromDate="2012-05-01",toDate="end","xbar",data_remove_nas,column)
                              dev.off()
                              cat('<center><img class="page-break-none" src="img/mchart_glucose_iv_started_age.png"></center>')
                            
                        %>                        
                    </ul>
                </li>
                <% previous.time <<- check_run_time(previous.time) %>
                <!-- ###################################################################################   -->
                <!-- ########## 7. Age Antibiotics Started (Minutes of Life) ###########################   -->
                <!-- ###################################################################################   -->
                <li class="section"><h2>Age Antibiotics Started (Minutes of Life)</h2>
                    <ul>
                        <li> 
                        <%
                            xbarI_section(nicu_subset,'antibiotics_started')
                              png('img/mchart_antibiotics_started.png',height=h,width=w-100)
                                data_remove_nas = subset(nicu_subset,!is.na(nicu_subset$antibiotics_started))
                                column = 'antibiotics_started'
                                my_qcc = xbarI_mean_plot(nicu_subset,column,yaxis_label="Minutes of Life")
                                ymax = max(my_qcc$limits)+5
                                ymin = min(my_qcc$limits)-5
                                mchart_plotdata = mchart(nicu_subset,column,c(ymin,ymax))
                                addShift(points=mchart_plotdata$y,groupSizes=mchart_plotdata$count,monthList,fromDate="2012-05-01",toDate="end","xbar",data_remove_nas,column)
                              dev.off()
                              cat('<center><img class="page-break-none" src="img/mchart_antibiotics_started.png"></center>')
                        %>                        
                    </ul>
                </li>
                <% previous.time <<- check_run_time(previous.time) %>
                <!-- ###################################################################################   -->
                <!-- ########## 8. PCO2 on first blood gas (mmHg) ###########################   -->
                <!-- ###################################################################################   -->
                <li class="section"><h2>PCO2 on first blood gas (mmHg)</h2>
                    <ul>
                        <li>
                        <%
                            xbarI_section(nicu_subset,'pco2_value',yaxis_label='mmHg')
                              png('img/mchart_pco2_value.png',height=h,width=w-100)
                                data_remove_nas = subset(nicu_subset,!is.na(nicu_subset$pco2_value))
                                column = 'pco2_value'
                                my_qcc = xbarI_mean_plot(nicu_subset,column,yaxis_label="mmHg")
                                ymax = max(my_qcc$limits)+5
                                ymin = min(my_qcc$limits)-5
                                mchart_plotdata = mchart(nicu_subset,column,c(ymin,ymax),yaxis_label="mmHg")
                                addShift(points=mchart_plotdata$y,groupSizes=mchart_plotdata$count,monthList,fromDate="2012-05-01",toDate="end","xbar",data_remove_nas,column)
                              dev.off()
                              cat('<center><img class="page-break-none" src="img/mchart_pco2_value.png"></center>')
                            
                        %>  
                    </ul>
                </li>
                <% previous.time <<- check_run_time(previous.time) %>
                <!-- ###################################################################################   -->
                <!-- ########## 9. Communication Phases ################################################   -->
                <!-- ###################################################################################   -->
                <li class="section page-break-before"><h2>Communication Phases</h2>
                    <ul><li>The following figures illustrate the breakdown of communication phase completion for each month (starting from kick-off). Missing fields are represented as "N/A". All records are included, regardless of whether communication data has been entered. </li></ul>
                    <%                        
                        stackedBarChart(rdata=rdata,columnOfInterest='pre_resusc_checklist',chartTitle='Pre-resuscitation Checklist Completed?')
                        stackedBarChart(rdata=rdata,columnOfInterest='pre_resusc_briefing',chartTitle=label(rdata)['pre_resusc_briefing'])
                        stackedBarChart(rdata=rdata,columnOfInterest='post_resusc_briefing',chartTitle=label(rdata)['post_resusc_briefing'])
                        stackedBarChart(rdata=nicu_subset,columnOfInterest='parents_commun',chartTitle=paste(label(nicu_subset)['parents_commun']," - Applies only to infants admitted to NICU",sep=""))
                    %>
                </li>
                <% previous.time <<- check_run_time(previous.time) %>
                <!-- ###################################################################################   -->
                <!-- ########## 10. Summary of Optional Outcome Data Fields ################################################   -->
                <!-- ###################################################################################   -->
                <li class="section page-break-before"><h2>Summary of Optional Outcome Data Fields</h2>                  
                    <%
                        optional_fields = select=c('discharge_date_fake','discharge_disp','oxygen_required','ivh3_4pvl','rop')
                        optional_subset = subset(nicu_subset,select=c('dob_fake',optional_fields))
                        denom = nrow(optional_subset)
                        percent_dod = round(sum(!is.na(optional_subset$discharge_date))/denom*100)
                        discharge_disp_count = sum(!is.na(optional_subset$discharge_disp))
                        
                        cat("<ul><li>Of <b>", denom,"</b> total record(s) admitted to the NICU, <b>", percent_dod,"%</b> have a discharge month and year recorded.</li>",sep="")
                        cat("<li>Of <b>",discharge_disp_count,"</b> case(s) with a discharge disposition reported:</li>",sep="")
                        cat("<ul>
                                <li><b>",round(sum(optional_subset$discharge_disp=="Home",na.rm=TRUE)/discharge_disp_count*100),"%</b> went home</li>
                                <li><b>",round(sum(optional_subset$discharge_disp=="Transfer",na.rm=TRUE)/discharge_disp_count*100),"%</b> transferred</li>
                                <li><b>",round(sum(optional_subset$discharge_disp=="Death",na.rm=TRUE)/discharge_disp_count*100),"%</b> died</li>
                            </ul><br/>",sep="")
                        cat("<li>Additional discharge data include:
                                <ul>
                                    <li><b>",sum(!is.na(optional_subset$oxygen_required)),"</b> cases had Oxygen requirement data, of which <b>",sum(optional_subset$oxygen_required=="Yes",na.rm=TRUE),"%</b> were noted to have an oxygen requirement at 36 week CGA.</li>
                                    <li><b>",sum(!is.na(optional_subset$ivh3_4pvl)),"</b> cases had IVH/PVL data, of which <b>",sum(optional_subset$ivh3_4pvl=="Yes",na.rm=TRUE),"%</b> were noted to have IVH 3 or 4/PVL at discharge.
                                    <li><b>",sum(!is.na(optional_subset$rop)),"</b> cases had ROP data, of which <b>",sum(optional_subset$rop=="Yes",na.rm=TRUE),"%</b> were noted to have ROP requiring intervention.
                                </ul>
                            </li></ul>",sep="")
                    %>
                </li>
	</ol>
  <% check_run_time(previous.time) %>
  <% check_run_time(begin.time) %>

</body>
</html>
